language: cpp

sudo: required

services:
  - docker

env:
  global:
    - CXX_FLAGS="-Wall -pedantic -Werror -Wno-variadic-macros -Wno-long-long -Wno-shadow"
    - RUN_TESTS=true
    - COVERAGE=true
    - LD_LIBRARY_PATH=/usr/local/lib

addons:
    apt:
        sources:
            - ubuntu-toolchain-r-test
            - llvm-toolchain-trusty-6.0
        packages:
            - cmake
            - gcc-7
            - clang-6.0
            - valgrind
            - g++-7
            - libstdc++-7-dev

matrix:
    include:
        - os: linux
          compiler: clang
          dist: trusty
          env: T=debug
        - os: linux
          compiler: gcc
          dist: trusty
          env: T=debug

branches:
    only:
        - master
        - develop

notifications:
  email: false

before_install:
  - docker run -p 81:80 kennethreitz/httpbin &
  - export CMAKE_OPTIONS=${CMAKE_OPTIONS}" "${ENV_CMAKE_OPTIONS}
  - export CXX_FLAGS=${CXX_FLAGS}" "${ENV_CXX_FLAGS}
  - mkdir build
  - cd build
  - mkdir docs
  - cmake --version
  - cmake ${CMAKE_OPTIONS} -DCMAKE_CXX_FLAGS=${CXX_FLAGS} -DCMAKE_BUILD_TYPE=Debug -DENABLE_COVERAGE=ON -DCOVERAGE=1 ..

install:
  - pip2 install --upgrade --user git+git://github.com/eddyxu/cpp-coveralls.git

script:
  - make
  - valgrind --suppressions=minimal.supp --gen-suppressions=all --leak-check=full --show-leak-kinds=all --errors-for-leak-kinds=all --track-fds=yes src/curlscript test/data/valgrind.cs
  - make test

after_success:
  - coveralls --build-root build --gcov-options '\-lp' -e build/curl-src -e build/cxxopts-src -e build/googletest-src -e build/loguru-src -e build/pugixml-src -e build/rapidjson-src -i /home/travis/build/xquery/curlscript
